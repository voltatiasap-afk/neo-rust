name: Deploy NeoRust

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-neorust
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    # CRITICAL: Setup persistent cache directories BEFORE git clean destroys them
    - name: Setup persistent cache directories
      run: |
        mkdir -p ~/.cache/sccache ~/.cargo/{registry,git,bin}
        echo "CARGO_HOME=$HOME/.cargo" >> $GITHUB_ENV
        echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV
        echo "RUSTUP_HOME=$HOME/.rustup" >> $GITHUB_ENV

    # Checkout with full history
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # PERFECT CACHING - survives git clean, hits correct paths
    - name: Cache Cargo registry, git deps, sccache, rustup
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ~/.cargo/bin
          ~/.cache/sccache
          ~/.rustup/toolchains
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/rust-toolchain.toml') || 'default' }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-

    # Rust nightly with components
    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly
        components: rustfmt, clippy

    # sccache setup
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.9
      
    # Build with comprehensive cache + stats
    - name: Build NeoRust
      env:
        SCCACHE_GHA_ENABLED: "true"
        RUSTC_WRAPPER: "sccache"
        CARGO_INCREMENTAL: "false"
        CARGO_NET_RETRY: "10"
        RUSTUP_MAX_RETRIES: "10"
      run: |
        cargo +nightly build --release --locked --all-features
        echo "::notice::SCCache stats:"
        sccache --show-stats || true
        
    # ATOMIC DEPLOY WITH ROLLBACK SAFETY
    - name: Deploy NeoRust
      run: |
        echo "ðŸ›‘ Stopping service..."
        systemctl --user stop neorust.service || true
        sleep 2
        
        # Backup existing binary
        if [ -f /home/volt/neo-rust/NeoRust ]; then
          mv /home/volt/neo-rust/NeoRust /home/volt/neo-rust/NeoRust.backup
          echo "ðŸ“¦ Backup created"
        fi
        
        # Deploy new binary atomically
        echo "ðŸš€ Deploying new binary..."
        mv target/release/NeoRust /home/volt/neo-rust/NeoRust.new
        chown volt:volt /home/volt/neo-rust/NeoRust.new
        mv /home/volt/neo-rust/Neo
