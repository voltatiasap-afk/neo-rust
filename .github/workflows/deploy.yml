name: Deploy NeoRust

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-neorust
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    # Setup persistent local cache directories (survives git clean)
    - name: Setup persistent cache directories
      run: |
        mkdir -p ~/.cache/sccache ~/.cargo/{registry,git,bin}
        echo "CARGO_HOME=$HOME/.cargo" >> $GITHUB_ENV
        echo "SCCACHE_DIR=$HOME/.cache/sccache" >> $GITHUB_ENV
        echo "RUSTUP_HOME=$HOME/.rustup" >> $GITHUB_ENV
        
    # Checkout with full history
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # Rust nightly with components (local rustup cache persists)
    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly
        components: rustfmt, clippy

    # sccache setup (local cache only)
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.9
      
    # Build with local cache + stats (no GitHub cache step needed)
    - name: Build NeoRust
      env:
        SCCACHE_GHA_ENABLED: "false"  # Disable any GHA-specific sccache upload
        RUSTC_WRAPPER: "sccache"
        CARGO_INCREMENTAL: "false"
        CARGO_NET_RETRY: "10"
        RUSTUP_MAX_RETRIES: "10"
      run: |
        cargo +nightly build --release --all-features
        echo "::notice::SCCache stats:"
        sccache --show-stats || true
        
    # Atomic deploy with rollback safety
    - name: Deploy NeoRust
      run: |
        echo "ðŸ›‘ Stopping service..."
        systemctl --user stop neorust.service || true
        sleep 2
        
        # Backup existing binary
        if [ -f /home/volt/neo-rust/NeoRust ]; then
          mv /home/volt/neo-rust/NeoRust /home/volt/neo-rust/NeoRust.backup
          echo "ðŸ“¦ Backup created"
        fi
        
        # Deploy new binary atomically
        echo "ðŸš€ Deploying new binary..."
        mv target/release/NeoRust /home/volt/neo-rust/NeoRust
        chown volt:volt /home/volt/neo-rust/NeoRust
        sleep 2
        systemctl --user start neorust.service
